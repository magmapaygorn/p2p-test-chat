<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Public P2P Chat</title>
<script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/uuid@9.0.0/dist/umd/uuidv4.min.js"></script>
<style>
body{margin:0;font-family:sans-serif;background:#202225;color:white;display:flex;flex-direction:column;height:100vh;}
#chatBox{flex:1;overflow-y:auto;padding:10px;border-bottom:1px solid #444;}
.message{margin:5px 0;}
.message.self{text-align:right;color:#00f;}
#members{padding:5px;background:#2f3136;}
.input-container{display:flex;padding:5px;background:#40444b;}
input,textarea{flex:1;padding:5px;margin-right:5px;border-radius:5px;background:#2f3136;color:white;border:none;}
button{padding:5px 10px;border:none;border-radius:5px;background:#5865f2;color:white;cursor:pointer;}
</style>
</head>
<body>

<div id="members">Members: <span id="memberList"></span></div>
<div id="chatBox"></div>

<div class="input-container">
<input id="msgInput" placeholder="Type a message...">
<button id="sendBtn">Send</button>
</div>

<div class="input-container" style="flex-direction:column;">
<input id="nameInput" placeholder="Enter your name">
<button id="genCodeBtn">Generate My Code</button>
<textarea id="myCode" placeholder="Share this with others"></textarea>
<textarea id="pasteCode" placeholder="Paste code from other peer"></textarea>
<button id="connectBtn">Connect to Peer</button>
</div>

<script>
const chatBox=document.getElementById('chatBox');
const msgInput=document.getElementById('msgInput');
const sendBtn=document.getElementById('sendBtn');
const nameInput=document.getElementById('nameInput');
const genCodeBtn=document.getElementById('genCodeBtn');
const myCode=document.getElementById('myCode');
const pasteCode=document.getElementById('pasteCode');
const connectBtn=document.getElementById('connectBtn');
const memberList=document.getElementById('memberList');

let myName='';
const localId=uuidv4();
const peers={};
const members={};
const receivedMessages=new Set();
// Limit the size of the received messages set to prevent memory issues
const MAX_RECEIVED_MESSAGES = 1000;

function addMessage(name,text,self=false){
  const div=document.createElement('div');
  div.className='message'+(self?' self':'');
  div.textContent=name+": "+text;
  chatBox.appendChild(div);
  chatBox.scrollTop=chatBox.scrollHeight;
}

function updateMembers(){
  memberList.textContent=Object.values(members).join(', ');
}

function broadcast(msg, exceptPeerId=null){
  Object.entries(peers).forEach(([id,peer])=>{
    if(id!==exceptPeerId && peer.connected) peer.send(JSON.stringify(msg));
  });
}

// Function to clean up old messages to prevent memory issues
function cleanReceivedMessages() {
  if (receivedMessages.size > MAX_RECEIVED_MESSAGES) {
    // Remove half of the oldest entries
    const arr = Array.from(receivedMessages);
    const toRemove = Math.floor(arr.length / 2);
    for (let i = 0; i < toRemove; i++) {
      receivedMessages.delete(arr[i]);
    }
  }
}

function createPeer(initiator=true, remoteSignal=null){
  const peerId=uuidv4();
  const peer=new SimplePeer({initiator,trickle:false});
  peers[peerId]=peer;

  peer.on('signal',data=>{
    myCode.value=JSON.stringify({peerId,signal:data,name:myName});
  });

  peer.on('data',raw=>{
    const msg=JSON.parse(raw);
    if(msg.id && receivedMessages.has(msg.id)) return;
    if(msg.id) {
      receivedMessages.add(msg.id);
      cleanReceivedMessages(); // Clean up old messages periodically
    }

    if(msg.type==='message'){
      addMessage(msg.name,msg.text,false);
      broadcast(msg, peerId);
    } else if(msg.type==='join'){
      members[msg.name]=msg.name;
      updateMembers();
      broadcast(msg, peerId);
    } else if(msg.type==='leave'){
      delete members[msg.name];
      updateMembers();
    }
  });

  peer.on('connect',()=>{
    members[myName]=myName;
    updateMembers();
    broadcast({type:'join',name:myName,id:localId});
  });

  peer.on('error', err => {
    console.error('Peer error:', err);
    delete peers[peerId];
    if (members[myName]) {
      delete members[myName];
      updateMembers();
    }
  });

  peer.on('close', () => {
    console.log('Peer connection closed:', peerId);
    delete peers[peerId];
    if (members[myName]) {
      delete members[myName];
      updateMembers();
    }
  });

  if(remoteSignal) peer.signal(remoteSignal.signal);

  return peer;
}

sendBtn.onclick=()=>{
  const text=msgInput.value.trim();
  if(!text) return;
  const id=uuidv4();
  const msg={type:'message',id,name:myName,text};
  addMessage(myName,text,true);
  receivedMessages.add(id);
  broadcast(msg);
  msgInput.value='';
};

genCodeBtn.onclick=()=>{
  myName=nameInput.value||'Anon';
  createPeer(true);
};

connectBtn.onclick=()=>{
  try{
    const remoteData=JSON.parse(pasteCode.value);
    myName=nameInput.value||'Anon';
    if(!peers[remoteData.peerId]){
      createPeer(false,remoteData);
    }
  }catch(e){alert('Invalid code');}
};

// Handle window unload to notify other peers about leaving
window.addEventListener('beforeunload', () => {
  broadcast({type:'leave',name:myName,id:localId});
});
</script>

</body>
</html>
