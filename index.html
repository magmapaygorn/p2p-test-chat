<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>P2P Chat Room</title>
<script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/uuid@9.0.0/dist/umd/uuidv4.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css" rel="stylesheet">
<style>
body { background: #1e1e2f; color: #f0f0f0; font-family: sans-serif; }
#chatBox { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:5px; }
.message { max-width:70%; padding:8px 12px; border-radius:12px; animation:fadeIn 0.3s ease; word-wrap: break-word; }
.message.self { background:#4ade80; color:black; align-self:flex-end; }
.message.peer { background:#6366f1; color:white; align-self:flex-start; }
@keyframes fadeIn { from {opacity:0; transform:translateY(5px);} to {opacity:1; transform:translateY(0);} }
</style>
</head>
<body class="flex flex-col h-screen p-4">

<header class="flex justify-between items-center mb-4">
  <h1 class="text-3xl font-bold">ðŸš€ P2P Chat</h1>
  <span id="roomCodeDisplay" class="bg-white/20 px-3 py-1 rounded">Room: PUBLIC</span>
</header>

<div class="flex gap-4 flex-1">
  <!-- Chat + Messages -->
  <div class="flex flex-col flex-1 bg-white/10 p-4 rounded-lg shadow-inner">
    <div id="chatBox" class="flex-1"></div>
    <div class="flex gap-2 mt-2">
      <input id="msgInput" type="text" placeholder="Type a message..." class="flex-1 p-2 rounded text-black"/>
      <button id="sendBtn" class="bg-green-500 px-4 rounded hover:bg-green-600">Send</button>
    </div>
  </div>

  <!-- Member Board -->
  <div class="w-48 bg-white/10 p-4 rounded-lg shadow-inner">
    <h2 class="text-xl font-semibold mb-2">ðŸ‘¥ Members</h2>
    <ul id="memberList" class="space-y-1"></ul>
  </div>
</div>

<div class="mt-4 flex gap-2">
  <input id="nameInput" class="p-2 rounded text-black flex-1" placeholder="Enter your name"/>
  <input id="codeInput" class="p-2 rounded text-black flex-1" placeholder="Room code (blank=public)"/>
  <button id="joinBtn" class="bg-blue-500 px-4 rounded hover:bg-blue-600">Join</button>
</div>

<script>
const chatBox = document.getElementById('chatBox');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const joinBtn = document.getElementById('joinBtn');
const codeInput = document.getElementById('codeInput');
const nameInput = document.getElementById('nameInput');
const memberList = document.getElementById('memberList');
const roomCodeDisplay = document.getElementById('roomCodeDisplay');

let peers = {};
let localId = uuidv4();
let myName = '';
let roomCode = 'public';
let members = {};

function addMessage(msg, self=false){
  const div = document.createElement('div');
  div.className = 'message ' + (self?'self':'peer');
  div.innerHTML = msg;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function updateMembers(){
  memberList.innerHTML = '';
  Object.values(members).forEach(m => {
    const li = document.createElement('li');
    li.textContent = m;
    memberList.appendChild(li);
  });
}

function broadcast(data){
  Object.values(peers).forEach(p=>p.send(JSON.stringify(data)));
}

function joinRoom(){
  myName = nameInput.value || 'Anon';
  roomCode = codeInput.value.trim() || 'public';
  roomCodeDisplay.textContent = 'Room: ' + roomCode;

  members[localId] = myName;
  updateMembers();
  addMessage(`<b>Joined room:</b> <span>${roomCode}</span>`, true);

  // Connect to existing peers in the room (simulated via localStorage)
  for(let key in localStorage){
    if(key.startsWith('signal-')){
      const sig = JSON.parse(localStorage[key]);
      if(sig.from!==localId && sig.room===roomCode){
        connectToPeer(sig.from, sig.data, false);
      }
    }
  }

  broadcast({type:'member-join', id:localId, name:myName, room:roomCode});
}

function connectToPeer(peerId, signalData=null, initiator=true){
  if(peers[peerId]) return;
  const peer = new SimplePeer({initiator, trickle:false});
  peers[peerId] = peer;

  peer.on('signal', data=>{
    localStorage.setItem('signal-'+peerId, JSON.stringify({from:localId, data, room:roomCode}));
  });

  peer.on('data', raw=>{
    const msg = JSON.parse(raw);
    if(msg.type==='message') addMessage(`<b>${msg.name}:</b> ${msg.text}`);
    else if(msg.type==='member-join'){ members[msg.id]=msg.name; updateMembers(); }
    else if(msg.type==='member-leave'){ delete members[msg.id]; updateMembers(); }
  });

  if(signalData) peer.signal(signalData);
}

function checkSignals(){
  for(let key in localStorage){
    if(key.startsWith('signal-')){
      const sig = JSON.parse(localStorage[key]);
      if(sig.from!==localId && sig.room===roomCode){
        if(!peers[sig.from]) connectToPeer(sig.from, sig.data, false);
        else peers[sig.from].signal(sig.data);
      }
    }
  }
}

setInterval(checkSignals, 1000);

joinBtn.onclick = joinRoom;
sendBtn.onclick = ()=>{
  const text = msgInput.value.trim();
  if(!text) return;
  addMessage(`<b>${myName}:</b> ${text}`, true);
  broadcast({type:'message', name:myName, text, room:roomCode});
  msgInput.value='';
};
msgInput.addEventListener('keypress', e=>{ if(e.key==='Enter') sendBtn.click(); });
</script>

</body>
</html>
