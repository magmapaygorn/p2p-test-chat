<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ultra P2P Chat</title>
<script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/uuid@9.0.0/dist/umd/uuidv4.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css" rel="stylesheet">
<style>
body { background: #1e1e2f; color: #f0f0f0; font-family: 'Segoe UI', sans-serif; }
#chatBox { flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:6px; padding:8px; }
.message { max-width:70%; padding:10px 14px; border-radius:16px; word-wrap: break-word; animation:fadeIn 0.3s ease; display:flex; align-items:center; gap:8px; }
.message.self { background:#4ade80; color:black; align-self:flex-end; }
.message.peer { background:#6366f1; color:white; align-self:flex-start; }
.avatar { width:32px; height:32px; border-radius:50%; display:flex; justify-content:center; align-items:center; font-weight:bold; color:white; flex-shrink:0; }
.timestamp { font-size:0.7rem; opacity:0.7; margin-left:auto; }
.typing-indicator { font-size:0.85rem; opacity:0.7; font-style:italic; margin-bottom:2px; }
@keyframes fadeIn { from {opacity:0; transform:translateY(5px);} to {opacity:1; transform:translateY(0);} }
</style>
</head>
<body class="flex flex-col h-screen p-4">

<header class="flex justify-between items-center mb-4">
  <h1 class="text-3xl font-bold">ðŸš€ Ultra P2P Chat</h1>
  <span id="roomCodeDisplay" class="bg-white/20 px-3 py-1 rounded">Room: PUBLIC</span>
</header>

<div class="flex gap-4 flex-1">
  <!-- Chat Area -->
  <div class="flex flex-col flex-1 bg-white/10 p-4 rounded-lg shadow-inner">
    <div id="chatBox" class="flex-1"></div>
    <div id="typingIndicator" class="typing-indicator"></div>
    <div class="flex gap-2 mt-2">
      <input id="msgInput" type="text" placeholder="Type a message..." class="flex-1 p-2 rounded text-black"/>
      <button id="sendBtn" class="bg-green-500 px-4 rounded hover:bg-green-600">Send</button>
    </div>
  </div>

  <!-- Member Board -->
  <div class="w-56 bg-white/10 p-4 rounded-lg shadow-inner flex flex-col">
    <h2 class="text-xl font-semibold mb-2">ðŸ‘¥ Members</h2>
    <ul id="memberList" class="space-y-2 flex-1 overflow-y-auto"></ul>
  </div>
</div>

<!-- Join Section -->
<div class="mt-4 flex gap-2">
  <input id="nameInput" class="p-2 rounded text-black flex-1" placeholder="Enter your name"/>
  <input id="codeInput" class="p-2 rounded text-black flex-1" placeholder="Room code (blank=public)"/>
  <button id="joinBtn" class="bg-blue-500 px-4 rounded hover:bg-blue-600">Join</button>
</div>

<script>
// -------------------- GLOBALS --------------------
const chatBox = document.getElementById('chatBox');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const joinBtn = document.getElementById('joinBtn');
const codeInput = document.getElementById('codeInput');
const nameInput = document.getElementById('nameInput');
const memberList = document.getElementById('memberList');
const roomCodeDisplay = document.getElementById('roomCodeDisplay');
const typingIndicator = document.getElementById('typingIndicator');

let peers = {};
let localId = uuidv4();
let myName = '';
let roomCode = 'public';
let members = {};
let avatars = {};
let typingTimeout;

// -------------------- AVATAR GENERATOR --------------------
function generateAvatar(name){
  const colors = ['#f87171','#fbbf24','#34d399','#60a5fa','#a78bfa','#f472b6'];
  const color = colors[Math.floor(Math.random()*colors.length)];
  return {color, initials: name.charAt(0).toUpperCase()};
}

// -------------------- ADD MESSAGE --------------------
function addMessage(name,text,self=false){
  const msgDiv = document.createElement('div');
  msgDiv.className = 'message ' + (self?'self':'peer');

  const avatarSpan = document.createElement('div');
  avatarSpan.className = 'avatar';
  avatarSpan.style.backgroundColor = avatars[name]?.color || '#888';
  avatarSpan.textContent = avatars[name]?.initials || name.charAt(0).toUpperCase();

  const contentDiv = document.createElement('div');
  contentDiv.innerHTML = `<b>${name}</b>: ${text} <span class="timestamp">${new Date().toLocaleTimeString().slice(0,5)}</span>`;

  msgDiv.appendChild(avatarSpan);
  msgDiv.appendChild(contentDiv);
  chatBox.appendChild(msgDiv);
  chatBox.scrollTop = chatBox.scrollHeight;
}

// -------------------- UPDATE MEMBER BOARD --------------------
function updateMembers(){
  memberList.innerHTML = '';
  Object.entries(members).forEach(([id,name])=>{
    const li = document.createElement('li');
    li.className='flex items-center gap-2';
    const avatarSpan = document.createElement('div');
    avatarSpan.className='avatar';
    avatarSpan.style.backgroundColor = avatars[name]?.color || '#888';
    avatarSpan.textContent = avatars[name]?.initials || name.charAt(0).toUpperCase();
    li.appendChild(avatarSpan);
    li.appendChild(document.createTextNode(name));
    memberList.appendChild(li);
  });
}

// -------------------- BROADCAST --------------------
function broadcast(data){
  Object.values(peers).forEach(p=>p.send(JSON.stringify(data)));
}

// -------------------- JOIN ROOM --------------------
function joinRoom(){
  myName = nameInput.value || 'Anon';
  roomCode = codeInput.value.trim() || 'public';
  roomCodeDisplay.textContent = 'Room: '+roomCode;

  members[localId]=myName;
  avatars[myName]=generateAvatar(myName);
  updateMembers();
  addMessage('System',`Joined room: ${roomCode}`,true);

  // Connect to peers in same room via localStorage dummy signaling
  for(let key in localStorage){
    if(key.startsWith('signal-')){
      const sig=JSON.parse(localStorage[key]);
      if(sig.from!==localId && sig.room===roomCode){
        connectToPeer(sig.from,sig.data,false);
      }
    }
  }
  broadcast({type:'member-join',id:localId,name:myName,room:roomCode});
}

// -------------------- CONNECT TO PEER --------------------
function connectToPeer(peerId,signalData=null,initiator=true){
  if(peers[peerId]) return;
  const peer = new SimplePeer({initiator,trickle:false});
  peers[peerId]=peer;

  peer.on('signal', data=>{
    localStorage.setItem('signal-'+peerId,JSON.stringify({from:localId,data,room:roomCode}));
  });

  peer.on('data', raw=>{
    const msg = JSON.parse(raw);
    handleIncoming(msg);
  });

  if(signalData) peer.signal(signalData);
}

// -------------------- HANDLE SIGNALS --------------------
function checkSignals(){
  for(let key in localStorage){
    if(key.startsWith('signal-')){
      const sig = JSON.parse(localStorage[key]);
      if(sig.from!==localId && sig.room===roomCode){
        if(!peers[sig.from]) connectToPeer(sig.from,sig.data,false);
        else peers[sig.from].signal(sig.data);
      }
    }
  }
}
setInterval(checkSignals,1000);

// -------------------- HANDLE INCOMING MESSAGES --------------------
function handleIncoming(msg){
  if(msg.type==='message') addMessage(msg.name,msg.text,false);
  else if(msg.type==='member-join'){
    members[msg.id]=msg.name;
    if(!avatars[msg.name]) avatars[msg.name]=generateAvatar(msg.name);
    updateMembers();
    addMessage('System',`${msg.name} joined the room`);
  }
  else if(msg.type==='member-leave'){
    delete members[msg.id];
    updateMembers();
    addMessage('System',`${msg.name} left the room`);
  }
  else if(msg.type==='typing'){
    showTyping(msg.name);
  }
}

// -------------------- TYPING INDICATOR --------------------
function showTyping(name){
  typingIndicator.textContent=`${name} is typing...`;
  clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>{ typingIndicator.textContent=''; },1500);
}

// -------------------- SEND MESSAGE --------------------
function sendMessage(){
  const text = msgInput.value.trim();
  if(!text) return;
  addMessage(myName,text,true);
  broadcast({type:'message',name:myName,text,room:roomCode});
  msgInput.value='';
}

// -------------------- EVENT LISTENERS --------------------
joinBtn.onclick=joinRoom;
sendBtn.onclick=sendMessage;
msgInput.addEventListener('keypress',e=>{
  if(e.key==='Enter') sendMessage();
  broadcast({type:'typing',name:myName,room:roomCode});
});
</script>

</body>
</html>
